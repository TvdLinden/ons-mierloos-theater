name: Sync Inventory

on:
  # schedule:
  # Runs every hour; adjust as needed
  # - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync-inventory:
    runs-on: ubuntu-latest
    steps:
      - name: Sync payments and orders (PowerShell logic in bash)
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          set -euo pipefail

          if [ -z "${CLIENT_ID:-}" ] || [ -z "${CLIENT_SECRET:-}" ] || [ -z "${BASE_URL:-}" ]; then
            echo "Required secrets CLIENT_ID, CLIENT_SECRET or BASE_URL are missing" >&2
            exit 1
          fi

          echo "Requesting token from $BASE_URL/api/oauth/token..."
          RESP=$(curl -sSL -X POST "$BASE_URL/api/oauth/token" \
            -H "Content-Type: application/json" \
            -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"$CLIENT_ID\",\"client_secret\":\"$CLIENT_SECRET\"}")


          # Try to parse access_token, fail if jq errors
          TOKEN=$(echo "$RESP" | jq -e -r '.access_token // empty') || {
            echo "Failed to parse token response as JSON. See above for raw response." >&2
            exit 5
          }
          if [ -z "$TOKEN" ]; then
            echo "No access_token in response. See above for raw response." >&2
            exit 1
          fi

          echo "Access token retrieved (first 8 chars): ${TOKEN:0:8}..."

          echo "Calling /api/admin/sync-payments with Bearer token..."
          PAYMENTS_RESP=$(curl -sSL -X POST "$BASE_URL/api/admin/sync-payments" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json")
          echo "sync-payments response:"
          echo "$PAYMENTS_RESP"

          echo "Calling /api/admin/sync-orders with Bearer token..."
          ORDERS_RESP=$(curl -sSL -X POST "$BASE_URL/api/admin/sync-orders" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json")
          echo "sync-orders response:"
          echo "$ORDERS_RESP"

          echo "Done."
