FROM node:20-alpine
WORKDIR /app

# Copy workspace package manifests (all three needed for npm ci)
COPY package.json package-lock.json ./
COPY shared/package.json shared/
COPY web/package.json web/
COPY worker/package.json worker/

RUN npm ci --omit=dev

# Copy source
COPY shared/lib shared/lib
COPY worker worker

# Port for health checks
EXPOSE 8080

# Run from worker dir so tsx picks up worker/tsconfig.json (which has @/* path alias)
WORKDIR /app/worker

# tsx is installed via worker/package.json; env vars injected by the runtime
CMD ["node", "--import", "tsx", "scripts/start-worker.ts"]
